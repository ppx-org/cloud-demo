

<script>
// S:y
// D:pId,P:y
// E:y,C:y

// %:d
// %:d,2:d
// %:d,2+:d
// E:y,-:y
// A:y
// y:Y,n:N
// +:y
// B:n,F:n





/*

dependence-D:12345,P:22.5-groupId=10000
最后change-E:50,C:14.9-groupId=20000

*/


var r = [];
/*
var s1 = {sId:1,pId:1,poli:"E:50,C:14.9",progId:99999,p:15.8,n:1}
var s2 = {sId:2,pId:1,poli:"E:50,C:14.9",progId:99999,p:15.9,n:3}
var s3 = {sId:3,pId:2,poli:"A:y",progId:888,p:10,n:1}
var s4 = {sId:4,poli:"%:0.8",progId:777,p:17.9,n:2}
var s5 = {sId:5,pId:18,poli:"D:2,P:12.5",progId:10000,p:15.7,n:2}
var s6 = {sId:6,pId:18,poli:"D:2,P:12.5",progId:10000,p:15.9,n:1}
var s7 = {sId:7,poli:"%:0.8",progId:777,p:15.9,n:4}
var s8 = {sId:8,pId:20,poli:"A:y",progId:888,p:10,n:1}
var s9 = {sId:9,pId:20,p:3,n:6}

r.push(s1);
r.push(s2);
r.push(s3);
r.push(s4);
r.push(s5);
r.push(s6);
r.push(s7);
r.push(s8);
r.push(s9);
*/

r.push({sId:1,pId:1,poli:"B:3,-:1",progId:123,p:8,n:7});
r.push({sId:3,pId:1,poli:"B:3,-:1",progId:123,p:8,n:7});
r.push({sId:2,pId:6,poli:"E:49,C:1.2",progId:123,p:7,n:2});
//r.push({sId:2,pId:1,poli:"B:3,-:1",progId:123,p:6,n:3});
//r.push({sId:2,pId:2,poli:"+:1",progId:123,p:15.8,n:4});
//r.push({sId:3,pId:3,poli:"+:1",progId:123,p:17.8,n:3});

var prodIdMap = {};
var groupN = {};
var enoughYen = {};
r.forEach(function(v) {
	prodIdMap[v.pId] = true;
	
	if (!v.progId) return;

	if (!groupN[v.progId]) {
		groupN[v.progId] = v.n;
		enoughYen[v.progId] = v.p * v.n;
	}
	else {
		groupN[v.progId] += v.n;
		enoughYen[v.progId] += v.p * v.n;
	}
	
	
});


var compare = function(obj1, obj2) {
    var val1 = obj1.progId;
    var val2 = obj2.progId;
    if (val1 < val2) {
        return -1;
    } else if (val1 > val2) {
        return 1;
    } else {
		var p1 = obj1.p;
		var p2 = obj2.p;
		if (p1 > p2) {
			return -1;
		} else if (p1 < p2) {
			return 1;
		}
        return 0;
    }            
}
r.sort(compare);


var count2discount = 0;
var countMoreAdd = 0;
var countBuyFree = 0;

var newR = r.map(function(v) {
	var poli = v.poli;
	var poli_1 = "";
	var poli_2 = "";
	var gN = groupN[v.progId];
	var eYen = enoughYen[v.progId];
	
	if (poli) {
		var item = poli.split(",");
		if (item.length == 1) {
			poli_1 = poli;
		}
		else if (item.length == 2) {
			poli_1 = item[0];
			poli_2 = item[1];
		}
	}
	
	
	if (poli == undefined) {
		v.itemP = v.p * v.n;
	}
	else if (poli.indexOf("S") == 0) {
		var p = new Number(poli_1.split(":")[1]);
		v.itemP = p * v.n;
	}
	else if (poli.indexOf("A") == 0) {
		var y = new Number(poli_1.split(":")[1]);
		v.itemP = y * v.n;
	}
	else if (poli.indexOf("%") == 0) {
		if (poli_2 == "" || gN == 1) {
			var d = new Number(poli_1.split(":")[1]);
			v.itemP = v.p * d * v.n;
		}
		else if (poli_2.indexOf("2+") == 0)  {
			d = new Number(poli_2.split(":")[1]);
			v.itemP = v.p * d * v.n;
		}
		else if (poli_2.indexOf("2") == 0) {
			var batch1D = new Number(poli_1.split(":")[1]);
			var batch2D = new Number(poli_2.split(":")[1]);			
			var batch1N = Math.floor(gN/2) - count2discount;
			count2discount += v.n;
			if (batch1N >= v.n) {
				v.itemP = v.p * v.n;
			}
			else if (batch1N <= 0) {
				v.itemP = v.p * batch2D;
			}
			else {
				alert(batch2D)
				v.itemP = v.p * batch1D * batch1N + v.p * batch2D * (v.n - batch1N);
			}
		}
	}
	else if (poli.indexOf("+") == 0) {
		if (gN == 1) {
			v.itemP = v.p;
		}
		else {
			var batch1Y = new Number(poli_1.split(":")[1]);
			var batch1N = Math.floor(gN/2) - countMoreAdd;
			countMoreAdd += v.n;
			if (batch1N >= v.n) {
				v.itemP = v.p * v.n;
			}
			else if (batch1N <= 0) {
				v.itemP = batch1Y * v.n;
			}
			else {
				v.itemP = v.p * batch1N + batch1Y * (v.n - batch1N);
			}
		}
	}
	else if (poli_1.split(":")[1] == 'Y') {
		var y = new Number(poli_1.split(":")[0]);
		var n = new Number(poli_2.split(":")[0]);
		if (n < gN) {
			var avgP = y/n;
			v.itemP = avgP * v.n;
		}
		else {
			v.itemP = v.p * v.n;
		}
	}
	else if (poli_1.split(":")[0] == 'E' && poli_2.split(":")[0] == '-') {
		var e = poli_1.split(":")[1];
		var y = poli_2.split(":")[1];
		
		if (eYen >= e) {
			var avgMinus = Math.floor(eYen/e) * y / gN;
			v.itemP = (v.p - avgMinus) * v.n;
		}
		else {
			v.itemP = v.p * v.n;
		}
	}
	else if (poli_1.split(":")[0] == 'B') {
		var buyN = new Number(poli_1.split(":")[1]);
		var freeN = new Number(poli_2.split(":")[1]);
		
		var gFreeN = Math.floor(gN/buyN) * freeN;
		
		var batch1N = gN - gFreeN - countBuyFree;
		countBuyFree += v.n;
		if (buyN > gN) {
			v.itemP = v.p * v.n;
		}
		else if (batch1N <= 0) {
			v.itemP = 0;
		}
		else {
			if (batch1N >= v.n) {
				v.itemP = v.p * v.n;
			}
			else {
				v.itemP = v.p * batch1N;
			}
		}
	}
	else if (poli_1.split(":")[0] == 'D') {
		var dependProdId = poli_1.split(":")[1];
		var dependPrice = poli_2.split(":")[1];
		if (prodIdMap[dependProdId]) {
			v.itemP = dependPrice * v.n;
		}
		else {
			v.itemP = v.p * v.n;
		}
	}
	
	if (!v.itemP) v.itemP = 0;
	//v.itemP = new Number(v.itemP);
	return v;
});



var excludeChangeTotalPrice = 0;
newR.forEach(function(v) {
	excludeChangeTotalPrice += v.itemP;
})


var resulltR = r.map(function(v) {
	var poli = v.poli;
	var poli_1 = "";
	var poli_2 = "";
	
	if (poli) {
		var item = poli.split(",");
		if (item.length == 1) {
			poli_1 = poli;
		}
		else if (item.length == 2) {
			poli_1 = item[0];
			poli_2 = item[1];
		}
	}
	
	if (poli_1.split(":")[0] == 'E' && poli_2.split(":")[0] == 'C') {
		var e = new Number(poli_1.split(":")[1]);
		var c = new Number(poli_2.split(":")[1]);
		if (excludeChangeTotalPrice >= e) {
			v.itemP = c * v.n;
		}
		else {
			v.itemP = v.p * v.n;
		}
	}
});

console.log(JSON.stringify(newR));






















</script>